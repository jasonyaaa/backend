# VocalBorn Celery + Redis ä»»å‹™è™•ç†å®Œæ•´æµç¨‹åœ–

## ğŸ“‹ ç›®éŒ„

- [ä¸»è¦è™•ç†æµç¨‹](#ä¸»è¦è™•ç†æµç¨‹)
- [Redis è³‡æ–™çµæ§‹è©³ç´°èªªæ˜](#redis-è³‡æ–™çµæ§‹è©³ç´°èªªæ˜)
- [éŒ¯èª¤è™•ç†æµç¨‹](#éŒ¯èª¤è™•ç†æµç¨‹)
- [ç³»çµ±ç›£æ§è¦–åœ–](#ç³»çµ±ç›£æ§è¦–åœ–)
- [ä»»å‹™ç‹€æ…‹ç”Ÿå‘½é€±æœŸ](#ä»»å‹™ç‹€æ…‹ç”Ÿå‘½é€±æœŸ)
- [æ•ˆèƒ½ç›£æ§æŒ‡æ¨™](#æ•ˆèƒ½ç›£æ§æŒ‡æ¨™)

---

## ğŸ”„ ä¸»è¦è™•ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            VocalBorn AI åˆ†æä»»å‹™è™•ç†æµç¨‹åœ–                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“± ç”¨æˆ¶ç«¯                    ğŸŒ FastAPI                    ğŸ“¦ Redis                   ğŸ”§ Celery Worker
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 1. POST /analyze          â”‚                           â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                           â”‚                          â”‚
   â”‚                           â”‚ 2. é©—è­‰ç”¨æˆ¶æ¬Šé™           â”‚                          â”‚
   â”‚                           â”‚    æª¢æŸ¥ PracticeRecord    â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚ 3. å»ºç«‹ AIAnalysisTask    â”‚                          â”‚
   â”‚                           â”‚    status: PENDING        â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚ 4. æäº¤ä»»å‹™åˆ° Redis       â”‚                          â”‚
   â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                          â”‚
   â”‚                           â”‚                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚                           â”‚                           â”‚ â”‚   Task Queue         â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚   (ai_analysis)      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚                      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ task_id: uuid        â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ args: [record_id,    â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚       params]        â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ status: PENDING      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 5. ç«‹å³å›æ‡‰ä»»å‹™ ID        â”‚                           â”‚                          â”‚
   â”‚ {"task_id": "xxx",        â”‚                           â”‚                          â”‚
   â”‚  "status": "pending"}     â”‚                           â”‚                          â”‚
   â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚ 6. Worker è¼ªè©¢ä½‡åˆ—     â”‚
   â”‚                           â”‚                           â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚ 7. å–å¾—ä»»å‹™             â”‚
   â”‚                           â”‚                           â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚ 8. é–‹å§‹è™•ç†
   â”‚                           â”‚                           â”‚                          â”‚    status: PROCESSING  
   â”‚                           â”‚                           â”‚                          â”‚    progress: 10%
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚ 9. æ›´æ–°ä»»å‹™ç‹€æ…‹        â”‚
   â”‚                           â”‚                           â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   â”‚                           â”‚                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚                           â”‚                           â”‚ â”‚   Result Cache       â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚                      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ task_id: uuid        â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ status: PROCESSING   â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ progress: 10%        â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ current_step: "åˆå§‹åŒ–" â”‚ â”‚
   â”‚                           â”‚                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 10. è¼ªè©¢ä»»å‹™ç‹€æ…‹          â”‚                           â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ 11. å¾ Redis è®€å–ç‹€æ…‹   â”‚                          â”‚
   â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 12. è¿”å›ç•¶å‰ç‹€æ…‹          â”‚                           â”‚                          â”‚
   â”‚ {"status": "processing",  â”‚                           â”‚                          â”‚
   â”‚  "progress": 40%}         â”‚                           â”‚                          â”‚
   â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚        â‹®                  â”‚           â‹®               â”‚            â‹®             â”‚
   â”‚   (æŒçºŒè¼ªè©¢)               â”‚      (ç‹€æ…‹æ›´æ–°)          â”‚     (é€²åº¦è¿½è¹¤)            â”‚
   â”‚        â‹®                  â”‚           â‹®               â”‚            â‹®             â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚ 13. AI æ¨¡å‹é‹ç®—
   â”‚                           â”‚                           â”‚                          â”‚     - ä¸‹è¼‰éŸ³è¨Šæª”æ¡ˆ
   â”‚                           â”‚                           â”‚                          â”‚     - å‘¼å« AI æœå‹™
   â”‚                           â”‚                           â”‚                          â”‚     - è™•ç†åˆ†æçµæœ
   â”‚                           â”‚                           â”‚                          â”‚     progress: 40â†’90%
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚ 14. æŒçºŒæ›´æ–°ç‹€æ…‹        â”‚
   â”‚                           â”‚                           â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚ 15. å„²å­˜æœ€çµ‚çµæœ
   â”‚                           â”‚                           â”‚                          â”‚     status: SUCCESS
   â”‚                           â”‚                           â”‚                          â”‚     progress: 100%
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚                           â”‚                           â”‚ 16. å®Œæˆç‹€æ…‹æ›´æ–°        â”‚
   â”‚                           â”‚                           â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   â”‚                           â”‚                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚                           â”‚                           â”‚ â”‚   Final Result       â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚                      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ task_id: uuid        â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ status: SUCCESS      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ progress: 100%       â”‚ â”‚
   â”‚                           â”‚                           â”‚ â”‚ result_id: uuid      â”‚ â”‚
   â”‚                           â”‚                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 17. æœ€çµ‚ç‹€æ…‹æŸ¥è©¢          â”‚                           â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ 18. æª¢æŸ¥å®Œæˆç‹€æ…‹        â”‚                          â”‚
   â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 19. ç²å–åˆ†æçµæœ          â”‚                           â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ 20. å¾è³‡æ–™åº«è®€å–çµæœ    â”‚                          â”‚
   â”‚                           â”‚                           â”‚                          â”‚
   â”‚ 21. è¿”å›å®Œæ•´åˆ†æçµæœ      â”‚                           â”‚                          â”‚
   â”‚ {"overall_score": 85.5,   â”‚                           â”‚                          â”‚
   â”‚  "suggestions": "..."}    â”‚                           â”‚                          â”‚
   â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                           â”‚                          â”‚
```

---

## ğŸ“¦ Redis è³‡æ–™çµæ§‹è©³ç´°èªªæ˜

### Database 0: ä»»å‹™ä½‡åˆ— (Task Queue)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key: celery                                                                              â”‚
â”‚ Type: List (FIFO Queue)                                                                  â”‚
â”‚                                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ â”‚ Task 1              â”‚  â”‚ Task 2              â”‚  â”‚ Task 3              â”‚               â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚               â”‚
â”‚ â”‚ id: uuid-1          â”‚  â”‚ id: uuid-2          â”‚  â”‚ id: uuid-3          â”‚               â”‚
â”‚ â”‚ task: analyze_audio â”‚  â”‚ task: analyze_audio â”‚  â”‚ task: analyze_audio â”‚               â”‚
â”‚ â”‚ args: [record_id_1] â”‚  â”‚ args: [record_id_2] â”‚  â”‚ args: [record_id_3] â”‚               â”‚
â”‚ â”‚ queue: ai_analysis  â”‚  â”‚ queue: ai_analysis  â”‚  â”‚ queue: ai_analysis  â”‚               â”‚
â”‚ â”‚ eta: null           â”‚  â”‚ eta: null           â”‚  â”‚ eta: null           â”‚               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     â†‘ (Pop)                                                       â†“ (Push)             â”‚
â”‚   Worker                                                         æ–°ä»»å‹™                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database 1: çµæœå¿«å– (Result Cache)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key Pattern: celery-task-meta-{task_id}                                                  â”‚
â”‚ Type: Hash                                                                               â”‚
â”‚                                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Key: celery-task-meta-550e8400-e29b-41d4-a716-446655440000                         â”‚  â”‚
â”‚ â”‚                                                                                     â”‚  â”‚
â”‚ â”‚ status: "PROCESSING"              â† ä»»å‹™ç‹€æ…‹                                        â”‚  â”‚
â”‚ â”‚ result: null                      â† æœ€çµ‚çµæœ (å®Œæˆå¾Œå¡«å…¥)                           â”‚  â”‚
â”‚ â”‚ traceback: null                   â† éŒ¯èª¤å †ç–Š (å¤±æ•—æ™‚å¡«å…¥)                           â”‚  â”‚
â”‚ â”‚ children: []                      â† å­ä»»å‹™ (é€šå¸¸ç‚ºç©º)                               â”‚  â”‚
â”‚ â”‚ date_done: null                   â† å®Œæˆæ™‚é–“                                        â”‚  â”‚
â”‚ â”‚ task_id: "550e8400-..."           â† ä»»å‹™ ID                                         â”‚  â”‚
â”‚ â”‚                                                                                     â”‚  â”‚
â”‚ â”‚ # è‡ªå®šç¾©é€²åº¦è³‡è¨Š                                                                   â”‚  â”‚
â”‚ â”‚ progress: 65                      â† é€²åº¦ç™¾åˆ†æ¯”                                      â”‚  â”‚
â”‚ â”‚ current_step: "AI æ¨¡å‹åˆ†æä¸­"      â† ç•¶å‰æ­¥é©Ÿæè¿°                                   â”‚  â”‚
â”‚ â”‚ worker_name: "worker@hostname"    â† åŸ·è¡Œçš„ Worker                                  â”‚  â”‚
â”‚ â”‚ started_at: "2024-01-01T12:00:00Z" â† é–‹å§‹æ™‚é–“                                      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                          â”‚
â”‚ TTL: 3600 seconds (1 hour)  â† è‡ªå‹•éæœŸæ™‚é–“                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redis æŒ‡ä»¤ç¯„ä¾‹

```bash
# æŸ¥çœ‹ä½‡åˆ—é•·åº¦
LLEN celery

# æŸ¥çœ‹ä½‡åˆ—ä¸­çš„ä»»å‹™ (ä¸ç§»é™¤)
LRANGE celery 0 -1

# æŸ¥çœ‹ä»»å‹™ç‹€æ…‹
HGETALL celery-task-meta-550e8400-e29b-41d4-a716-446655440000

# æŸ¥çœ‹æ‰€æœ‰ä»»å‹™ç‹€æ…‹ keys
KEYS celery-task-meta-*

# æ¸…ç†éæœŸçš„ä»»å‹™çµæœ
EXPIRE celery-task-meta-550e8400-e29b-41d4-a716-446655440000 3600
```

---

## âš ï¸ éŒ¯èª¤è™•ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­£å¸¸æµç¨‹ â”€â”€â†’ åŸ·è¡Œä»»å‹™ â”€â”€â†’ æˆåŠŸ â”€â”€â†’ æ›´æ–°ç‹€æ…‹ SUCCESS
    â”‚             â”‚
    â”‚             â†“ (ç™¼ç”ŸéŒ¯èª¤)
    â”‚         æ•ç²ç•°å¸¸
    â”‚             â”‚
    â”‚             â†“
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      æ˜¯     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ é‡è©¦æ¬¡æ•¸ < 3 ? â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ›´æ–°ç‹€æ…‹ RETRY   â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚                              â”‚
    â”‚             â”‚ å¦                          â”‚
    â”‚             â†“                              â†“
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
    â”‚    â”‚ æ›´æ–°ç‹€æ…‹ FAILURE â”‚                    â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
    â”‚             â”‚                              â”‚
    â”‚             â†“                              â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      å»¶é²60ç§’       â”‚
    â”‚    â”‚ è¨˜éŒ„éŒ¯èª¤è¨Šæ¯    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â”‚             â†“
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ é‡ç½® Practice   â”‚
    â”‚    â”‚ Record ç‹€æ…‹     â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â”‚             â†“
    â””â”€â”€â”€â”€â†’ ä»»å‹™çµæŸ (å¤±æ•—)
```

### éŒ¯èª¤é¡å‹è™•ç†

| éŒ¯èª¤é¡å‹ | é‡è©¦ç­–ç•¥ | å»¶é²æ™‚é–“ | æœ€å¤§é‡è©¦ |
|---------|---------|---------|---------|
| ç¶²è·¯éŒ¯èª¤ | æŒ‡æ•¸é€€é¿ | 30s, 60s, 120s | 5æ¬¡ |
| AIæœå‹™éŒ¯èª¤ | å›ºå®šå»¶é² | 60s | 3æ¬¡ |
| æª”æ¡ˆéŒ¯èª¤ | ä¸é‡è©¦ | - | 0æ¬¡ |
| è¶…æ™‚éŒ¯èª¤ | å›ºå®šå»¶é² | 120s | 2æ¬¡ |

### Redis ä¸­çš„éŒ¯èª¤è³‡è¨Š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key: celery-task-meta-{failed_task_id}                                                   â”‚
â”‚                                                                                          â”‚
â”‚ status: "FAILURE"                                                                        â”‚
â”‚ result: null                                                                             â”‚
â”‚ traceback: "Traceback (most recent call last):\n  File..."                              â”‚
â”‚ children: []                                                                             â”‚
â”‚ date_done: "2024-01-01T12:05:30.123Z"                                                   â”‚
â”‚ task_id: "550e8400-..."                                                                  â”‚
â”‚ error_message: "AI æ¨¡å‹æœå‹™ç„¡æ³•é€£æ¥: Connection timeout"                                  â”‚
â”‚ retry_count: 3                                                                           â”‚
â”‚ max_retries: 3                                                                           â”‚
â”‚ worker_name: "worker@srv1"                                                               â”‚
â”‚ failed_at: "2024-01-01T12:05:30Z"                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ç³»çµ±ç›£æ§è¦–åœ–

### Flower ç›£æ§ä»‹é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Flower ç›£æ§ä»‹é¢è³‡è¨Š                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Active Tasks (é€²è¡Œä¸­ä»»å‹™)

| Task ID | Name | State | Progress | Worker | Started At |
|---------|------|--------|----------|---------|------------|
| 550e8400-... | analyze_audio | PROCESSING | 65% | worker@srv1 | 12:00:15 |
| 661f9511-... | analyze_audio | PROCESSING | 20% | worker@srv1 | 12:01:02 |
| 772fa622-... | analyze_audio | PENDING | 0% | - | - |

#### Queue Status (ä½‡åˆ—ç‹€æ…‹)

| Queue Name | Pending Tasks | Active Tasks | Workers | Throughput/min |
|------------|---------------|--------------|---------|----------------|
| ai_analysis | 3 | 2 | 4 | 15 |

#### Worker Status (Worker ç‹€æ…‹)

| Worker Name | Status | Active | Processed | Failed | Load Avg | Memory Usage |
|-------------|--------|--------|-----------|--------|----------|--------------|
| worker@srv1 | Online | 2 | 145 | 3 | 1.2 | 512MB |

---

## ğŸ”„ ä»»å‹™ç‹€æ…‹ç”Ÿå‘½é€±æœŸ

```mermaid
graph TD
    A[PENDING] --> B[PROCESSING]
    B --> C{åŸ·è¡Œçµæœ}
    C -->|æˆåŠŸ| D[SUCCESS]
    C -->|å¤±æ•—| E{é‡è©¦æ¬¡æ•¸}
    E -->|< 3æ¬¡| F[RETRY]
    E -->|>= 3æ¬¡| G[FAILURE]
    F --> H[ç­‰å¾…60ç§’]
    H --> B
    
    style A fill:#fff2cc
    style B fill:#d5e8d4
    style D fill:#d4edda
    style G fill:#f8d7da
    style F fill:#ffeaa7
```

### ç‹€æ…‹èªªæ˜

- **PENDING**: ä»»å‹™å·²æäº¤åˆ°ä½‡åˆ—ï¼Œç­‰å¾… Worker è™•ç†
- **PROCESSING**: Worker æ­£åœ¨åŸ·è¡Œä»»å‹™ï¼ŒåŒ…å«é€²åº¦è¿½è¹¤
- **SUCCESS**: ä»»å‹™åŸ·è¡ŒæˆåŠŸï¼Œçµæœå·²å„²å­˜
- **FAILURE**: ä»»å‹™åŸ·è¡Œå¤±æ•—ï¼Œé”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸
- **RETRY**: ä»»å‹™åŸ·è¡Œå¤±æ•—ï¼Œæº–å‚™é‡è©¦

---

## ğŸ“ˆ æ•ˆèƒ½ç›£æ§æŒ‡æ¨™

### é—œéµæŒ‡æ¨™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                æ•ˆèƒ½ç›£æ§æŒ‡æ¨™                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š ä»»å‹™è™•ç†æŒ‡æ¨™:
â”œâ”€â”€ å¹³å‡è™•ç†æ™‚é–“: 35.2 ç§’
â”œâ”€â”€ æˆåŠŸç‡: 94.5%
â”œâ”€â”€ å¤±æ•—ç‡: 5.5%
â””â”€â”€ é‡è©¦ç‡: 12.3%

ğŸ“Š ä½‡åˆ—ç‹€æ…‹æŒ‡æ¨™:
â”œâ”€â”€ ç•¶å‰ä½‡åˆ—é•·åº¦: 3 å€‹ä»»å‹™
â”œâ”€â”€ å¹³å‡ç­‰å¾…æ™‚é–“: 2.1 ç§’
â”œâ”€â”€ æœ€é•·ç­‰å¾…æ™‚é–“: 15.6 ç§’
â””â”€â”€ æ¯å°æ™‚è™•ç†é‡: 85 å€‹ä»»å‹™

ğŸ“Š Worker æ•ˆèƒ½æŒ‡æ¨™:
â”œâ”€â”€ Worker æ•¸é‡: 4 å€‹
â”œâ”€â”€ CPU ä½¿ç”¨ç‡: 65%
â”œâ”€â”€ è¨˜æ†¶é«”ä½¿ç”¨ç‡: 512MB / 2GB
â””â”€â”€ ç¶²è·¯IO: 125 KB/s

ğŸ“Š Redis æ•ˆèƒ½æŒ‡æ¨™:
â”œâ”€â”€ è¨˜æ†¶é«”ä½¿ç”¨: 256MB / 2GB
â”œâ”€â”€ é€£ç·šæ•¸: 12 / 100
â”œâ”€â”€ QPS: 450 queries/sec
â””â”€â”€ å‘½ä¸­ç‡: 98.2%
```

### å‘Šè­¦é–¾å€¼è¨­å®š

```yaml
alerts:
  - name: ä½‡åˆ—ç©å£“å‘Šè­¦
    condition: queue_length > 50
    severity: warning
    
  - name: ä»»å‹™å¤±æ•—ç‡å‘Šè­¦
    condition: failure_rate > 10%
    severity: critical
    
  - name: Worker é›¢ç·šå‘Šè­¦
    condition: active_workers == 0
    severity: critical
    
  - name: è™•ç†æ™‚é–“ç•°å¸¸å‘Šè­¦
    condition: avg_processing_time > 60s
    severity: warning
    
  - name: Redis è¨˜æ†¶é«”ä½¿ç”¨å‘Šè­¦
    condition: redis_memory_usage > 80%
    severity: warning
```

---

## ğŸ” æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

#### 1. ä»»å‹™é•·æ™‚é–“åœç•™åœ¨ PENDING ç‹€æ…‹

**åŸå› åˆ†æ**:
- Worker æœªå•Ÿå‹•æˆ–å·²åœæ­¢
- Redis é€£ç·šå•é¡Œ
- ä½‡åˆ—é…ç½®éŒ¯èª¤

**è§£æ±ºæ­¥é©Ÿ**:
```bash
# æª¢æŸ¥ Worker ç‹€æ…‹
celery -A src.tasks.celery_app inspect active

# æª¢æŸ¥ Redis é€£ç·š
redis-cli ping

# é‡å•Ÿ Worker
docker restart vocalborn-celery-worker
```

#### 2. ä»»å‹™åŸ·è¡Œè¶…æ™‚

**åŸå› åˆ†æ**:
- AI æ¨¡å‹æœå‹™å›æ‡‰ç·©æ…¢
- ç¶²è·¯é€£ç·šä¸ç©©å®š
- éŸ³è¨Šæª”æ¡ˆéå¤§

**è§£æ±ºæ­¥é©Ÿ**:
```bash
# æª¢æŸ¥ AI æœå‹™ç‹€æ…‹
curl -f http://ai-service:8001/health

# èª¿æ•´è¶…æ™‚è¨­å®š
export CELERY_TASK_TIME_LIMIT=1800  # 30 åˆ†é˜

# ç›£æ§ç¶²è·¯ç‹€æ³
ping ai-service
```

#### 3. è¨˜æ†¶é«”ä½¿ç”¨éé«˜

**åŸå› åˆ†æ**:
- Worker è™•ç†å¤§é‡ä»»å‹™æœªé‡‹æ”¾è¨˜æ†¶é«”
- Redis å¿«å–ç©ç´¯éå¤šè³‡æ–™
- è¨˜æ†¶é«”æ´©æ¼å•é¡Œ

**è§£æ±ºæ­¥é©Ÿ**:
```bash
# å®šæœŸé‡å•Ÿ Worker
docker restart vocalborn-celery-worker

# æ¸…ç†éæœŸçš„ Redis è³‡æ–™
redis-cli --scan --pattern "celery-task-meta-*" | xargs redis-cli del

# èª¿æ•´ Worker è¨­å®š
export CELERY_WORKER_MAX_TASKS_PER_CHILD=100
```

---

## ğŸ“ ç¶­é‹æª¢æŸ¥æ¸…å–®

### æ—¥å¸¸æª¢æŸ¥ (æ¯æ—¥)

- [ ] æª¢æŸ¥ Worker ç‹€æ…‹æ˜¯å¦åœ¨ç·š
- [ ] æª¢æŸ¥ä½‡åˆ—é•·åº¦æ˜¯å¦æ­£å¸¸ (< 10)
- [ ] æª¢æŸ¥ä»»å‹™æˆåŠŸç‡ (> 90%)
- [ ] æª¢æŸ¥ Redis è¨˜æ†¶é«”ä½¿ç”¨ (< 70%)
- [ ] æª¢æŸ¥éŒ¯èª¤æ—¥èªŒæ˜¯å¦æœ‰ç•°å¸¸

### é€±æœŸæª¢æŸ¥ (æ¯é€±)

- [ ] æ¸…ç†éæœŸçš„ä»»å‹™çµæœ
- [ ] åˆ†æä»»å‹™è™•ç†æ•ˆèƒ½è¶¨å‹¢
- [ ] æª¢æŸ¥ä¸¦æ›´æ–°ç›£æ§å‘Šè­¦è¦å‰‡
- [ ] å‚™ä»½é‡è¦çš„é…ç½®æª”æ¡ˆ
- [ ] æ¸¬è©¦ç½é›£æ¢å¾©æµç¨‹

### æœˆåº¦æª¢æŸ¥ (æ¯æœˆ)

- [ ] ç³»çµ±æ•ˆèƒ½å…¨é¢è©•ä¼°
- [ ] å®¹é‡è¦åŠƒå’Œæ“´å±•è©•ä¼°
- [ ] å®‰å…¨æ€§æª¢æŸ¥å’Œæ›´æ–°
- [ ] æ–‡ä»¶æ›´æ–°å’Œç¶­è­·
- [ ] åœ˜éšŠåŸ¹è¨“å’ŒçŸ¥è­˜åˆ†äº«

---

*æœ¬æ–‡ä»¶æè¿°äº† VocalBorn ç³»çµ±çš„ Celery + Redis ä»»å‹™è™•ç†å®Œæ•´æµç¨‹ï¼ŒåŒ…å«æ‰€æœ‰é—œéµçµ„ä»¶çš„äº’å‹•æ–¹å¼ã€éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€ç›£æ§æŒ‡æ¨™å’Œç¶­é‹æŒ‡å—ã€‚*