# æ‚£è€…ç«¯å–å¾—æ²»ç™‚å¸«å›é¥‹åŠŸèƒ½è¦åŠƒ

## æ¦‚è¿°

æœ¬æ–‡ä»¶è¦åŠƒæ‚£è€…ç«¯æŸ¥çœ‹å’Œäº’å‹•æ²»ç™‚å¸«å›é¥‹åŠŸèƒ½çš„å®Œæ•´æ¶æ§‹è¨­è¨ˆã€‚åŸºæ–¼ç¾æœ‰çš„ `PracticeSessionFeedback` å’Œ `AIAnalysisResult` æ¨¡å‹ï¼Œè¨­è¨ˆæ‚£è€…å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å·²å®Œæˆç·´ç¿’æœƒè©±çš„å›é¥‹ï¼Œä¸¦æä¾›ç¯©é¸ã€æŸ¥çœ‹è©³æƒ…å’Œäº’å‹•åŠŸèƒ½ã€‚

## 1. åŠŸèƒ½è¦åŠƒ

### 1.1 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

#### æŸ¥çœ‹æ¬Šé™èˆ‡ç¯„åœ
- âœ… æ‚£è€…å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å·²å®Œæˆç·´ç¿’æœƒè©±çš„å›é¥‹
- âœ… æ”¯æ´ç¯©é¸åŠŸèƒ½ï¼ˆæŒ‰æ™‚é–“ç¯„åœã€ç« ç¯€ã€æ²»ç™‚å¸«ç¯©é¸ï¼‰
- âœ… æ‚£è€…å¯ä»¥åŒæ™‚æŸ¥çœ‹ AI åˆ†æçµæœå’Œæ²»ç™‚å¸«å›é¥‹
- âœ… å›é¥‹éœ€è¦åŒ…å«æ²»ç™‚å¸«çš„åŸºæœ¬è³‡è¨Šï¼ˆå§“åã€å°ˆé•·ç­‰ï¼‰

#### å›é¥‹å…§å®¹å±•ç¤º
- å±•ç¤ºæ²»ç™‚å¸«å›é¥‹çš„å®Œæ•´å…§å®¹
- å±•ç¤ºå°æ‡‰çš„ AI åˆ†æçµæœï¼ˆå¦‚å­˜åœ¨ï¼‰
- é—œè¯å±•ç¤ºç·´ç¿’è¨˜éŒ„ï¼ˆéŸ³è¨Šæª”æ¡ˆï¼‰
- æä¾› AI åˆ†æèˆ‡æ²»ç™‚å¸«å›é¥‹çš„å°æ¯”æª¢è¦–

#### äº’å‹•åŠŸèƒ½
- âœ… æ‚£è€…èƒ½å°å›é¥‹é€²è¡Œå›æ‡‰æˆ–æå•
- å»ºç«‹æ‚£è€…èˆ‡æ²»ç™‚å¸«çš„ç°¡æ˜“æºé€šæ©Ÿåˆ¶

#### é€šçŸ¥æ©Ÿåˆ¶
- ğŸš§ #TODO: ç•¶æœ‰æ–°å›é¥‹æ™‚é€šçŸ¥æ‚£è€…ï¼ˆé ç•™åŠŸèƒ½ï¼‰

### 1.2 ç”¨æˆ¶ä½¿ç”¨æµç¨‹

```
æ‚£è€…ç™»å…¥ â†’ é€²å…¥å›é¥‹é é¢ â†’ 
ç¯©é¸å›é¥‹åˆ—è¡¨ â†’ é¸æ“‡ç‰¹å®šå›é¥‹ â†’ 
æŸ¥çœ‹è©³ç´°å…§å®¹ï¼ˆæ²»ç™‚å¸«å›é¥‹ + AI åˆ†æå°æ¯”ï¼‰â†’ 
æŸ¥çœ‹é—œè¯ç·´ç¿’è¨˜éŒ„ â†’ 
ï¼ˆå¯é¸ï¼‰å›æ‡‰æˆ–æå• â†’ å®Œæˆ
```

### 1.3 æ¥­å‹™è¦å‰‡

1. **æ¬Šé™æ§åˆ¶**ï¼šæ‚£è€…åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç·´ç¿’æœƒè©±å›é¥‹
2. **è³‡æ–™å®Œæ•´æ€§**ï¼šåªæœ‰å·²å®Œæˆçš„ç·´ç¿’æœƒè©±æ‰å¯èƒ½æœ‰æ²»ç™‚å¸«å›é¥‹
3. **å›é¥‹å¯è¦‹æ€§**ï¼šæ‰€æœ‰æ²»ç™‚å¸«å›é¥‹å°æ‚£è€…å¯è¦‹ï¼Œç„¡éš±ç§é™åˆ¶
4. **äº’å‹•é™åˆ¶**ï¼šæ‚£è€…åªèƒ½å›æ‡‰ï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆªé™¤å›é¥‹
5. **é—œè¯å±•ç¤º**ï¼šå›é¥‹å¿…é ˆèˆ‡å°æ‡‰çš„ç·´ç¿’è¨˜éŒ„å’Œ AI åˆ†æçµæœé—œè¯å±•ç¤º

## 2. Router è¦åŠƒ

### 2.1 æ‚£è€…å›é¥‹æŸ¥çœ‹è·¯ç”±å™¨ (`patient_feedback_router.py`)

```python
# è·¯ç”±å™¨æª”æ¡ˆä½ç½®ï¼šsrc/practice/routers/patient_feedback_router.py
# è·¯ç”±å™¨åç¨±ï¼špatient_feedback_router
```

#### API ç«¯é»è¨­è¨ˆ

##### 2.1.1 å–å¾—å›é¥‹åˆ—è¡¨
```
GET /api/practice/patient/feedbacks
```

**åŠŸèƒ½**ï¼šå–å¾—æ‚£è€…çš„æ‰€æœ‰å›é¥‹åˆ—è¡¨ï¼Œæ”¯æ´ç¯©é¸å’Œåˆ†é 

**Query Parameters**ï¼š
- `page`: é ç¢¼ (é è¨­: 1)
- `limit`: æ¯é æ•¸é‡ (é è¨­: 10, æœ€å¤§: 50)
- `chapter_id`: ç« ç¯€ ID ç¯©é¸ (å¯é¸)
- `therapist_id`: æ²»ç™‚å¸« ID ç¯©é¸ (å¯é¸)
- `start_date`: é–‹å§‹æ—¥æœŸç¯©é¸ (å¯é¸ï¼ŒISO æ ¼å¼)
- `end_date`: çµæŸæ—¥æœŸç¯©é¸ (å¯é¸ï¼ŒISO æ ¼å¼)
- `has_ai_analysis`: æ˜¯å¦åŒ…å« AI åˆ†æ (å¯é¸ï¼Œboolean)

**å›æ‡‰æ ¼å¼**ï¼š
```json
{
  "feedbacks": [
    {
      "session_feedback_id": "uuid",
      "practice_session_id": "uuid",
      "chapter_name": "åŸºæœ¬å°è©±",
      "therapist_name": "å¼µæ²»ç™‚å¸«",
      "therapist_specialties": ["ç™¼éŸ³çŸ¯æ­£", "èªèª¿è¨“ç·´"],
      "content": "æ•´é«”è¡¨ç¾è‰¯å¥½...",
      "has_ai_analysis": true,
      "created_at": "2025-07-30T14:30:00.000Z",
      "patient_responses_count": 2
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total_items": 25,
    "total_pages": 3
  }
}
```

##### 2.1.2 å–å¾—å›é¥‹è©³æƒ…
```
GET /api/practice/patient/feedbacks/{feedback_id}
```

**åŠŸèƒ½**ï¼šå–å¾—ç‰¹å®šå›é¥‹çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…å« AI åˆ†æå°æ¯”

**Path Parameters**ï¼š
- `feedback_id`: å›é¥‹ ID

**å›æ‡‰æ ¼å¼**ï¼š
```json
{
  "session_feedback_id": "uuid",
  "practice_session_id": "uuid",
  "chapter": {
    "chapter_id": "uuid",
    "chapter_name": "åŸºæœ¬å°è©±",
    "description": "æ—¥å¸¸å°è©±ç·´ç¿’"
  },
  "therapist": {
    "therapist_id": "uuid",
    "name": "å¼µæ²»ç™‚å¸«",
    "specialties": ["ç™¼éŸ³çŸ¯æ­£", "èªèª¿è¨“ç·´"],
    "years_experience": 5
  },
  "therapist_feedback": {
    "content": "æ•´é«”è¡¨ç¾è‰¯å¥½...",
    "created_at": "2025-07-30T14:30:00.000Z"
  },
  "ai_analysis": {
    "analysis_result": {
      "overall_score": 85,
      "pronunciation_accuracy": 88,
      "fluency_score": 82,
      "detailed_analysis": "..."
    },
    "created_at": "2025-07-30T14:00:00.000Z"
  },
  "practice_records": [
    {
      "practice_record_id": "uuid",
      "sentence_content": "ä½ å¥½ï¼Œå¾ˆé«˜èˆˆè¦‹åˆ°ä½ ",
      "audio_path": "/audio/path",
      "audio_duration": 3.5,
      "recorded_at": "2025-07-30T13:45:00.000Z"
    }
  ],
  "patient_responses": [
    {
      "response_id": "uuid",
      "content": "è¬è¬æ²»ç™‚å¸«çš„æŒ‡å°",
      "created_at": "2025-07-30T15:00:00.000Z"
    }
  ]
}
```

##### 2.1.3 å›æ‡‰å›é¥‹
```
POST /api/practice/patient/feedbacks/{feedback_id}/responses
```

**åŠŸèƒ½**ï¼šæ‚£è€…å°æ²»ç™‚å¸«å›é¥‹é€²è¡Œå›æ‡‰æˆ–æå•

**Path Parameters**ï¼š
- `feedback_id`: å›é¥‹ ID

**è«‹æ±‚æ ¼å¼**ï¼š
```json
{
  "content": "è¬è¬æ²»ç™‚å¸«çš„è©³ç´°å›é¥‹ï¼Œæˆ‘æœƒåŠ å¼·èªèª¿ç·´ç¿’",
  "response_type": "response"  // "response" æˆ– "question"
}
```

**å›æ‡‰æ ¼å¼**ï¼š
```json
{
  "response_id": "uuid",
  "feedback_id": "uuid",
  "content": "è¬è¬æ²»ç™‚å¸«çš„è©³ç´°å›é¥‹ï¼Œæˆ‘æœƒåŠ å¼·èªèª¿ç·´ç¿’",
  "response_type": "response",
  "created_at": "2025-07-30T15:00:00.000Z"
}
```

##### 2.1.4 å–å¾—å›é¥‹çµ±è¨ˆ
```
GET /api/practice/patient/feedbacks/statistics
```

**åŠŸèƒ½**ï¼šå–å¾—æ‚£è€…å›é¥‹çš„çµ±è¨ˆè³‡è¨Š

**å›æ‡‰æ ¼å¼**ï¼š
```json
{
  "total_feedbacks": 25,
  "feedbacks_this_month": 8,
  "avg_improvement_score": 78.5,
  "most_active_therapist": {
    "therapist_id": "uuid",
    "name": "å¼µæ²»ç™‚å¸«",
    "feedback_count": 15
  },
  "chapter_feedback_distribution": [
    {
      "chapter_name": "åŸºæœ¬å°è©±",
      "feedback_count": 10
    }
  ]
}
```

### 2.2 æ¬Šé™æ§åˆ¶æ©Ÿåˆ¶

#### èº«ä»½é©—è­‰
- ä½¿ç”¨ç¾æœ‰çš„ JWT token é©—è­‰
- ç¢ºä¿åªæœ‰æ‚£è€…èº«ä»½å¯ä»¥å­˜å–

#### è³‡æ–™æ¬Šé™
- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç·´ç¿’æœƒè©±å›é¥‹
- é€é `user_id` èˆ‡ `practice_session.user_id` æ¯”å°ç¢ºèªæ¬Šé™

#### éŒ¯èª¤è™•ç†
- `403 Forbidden`ï¼šç„¡æ¬Šé™å­˜å–
- `404 Not Found`ï¼šå›é¥‹ä¸å­˜åœ¨
- `400 Bad Request`ï¼šè«‹æ±‚åƒæ•¸éŒ¯èª¤

## 3. Service è¦åŠƒ

### 3.1 æ‚£è€…å›é¥‹æœå‹™ (`patient_feedback_service.py`)

```python
# æœå‹™æª”æ¡ˆä½ç½®ï¼šsrc/practice/services/patient_feedback_service.py
```

#### æ ¸å¿ƒæœå‹™å‡½æ•¸

##### 3.1.1 å–å¾—æ‚£è€…å›é¥‹åˆ—è¡¨
```python
async def get_patient_feedbacks(
    patient_id: uuid.UUID,
    filters: FeedbackFilters,
    session: Session
) -> PaginatedFeedbackListResponse:
    """
    å–å¾—æ‚£è€…çš„å›é¥‹åˆ—è¡¨ï¼Œæ”¯æ´ç¯©é¸å’Œåˆ†é 
    
    Args:
        patient_id: æ‚£è€… ID
        filters: ç¯©é¸æ¢ä»¶ï¼ˆç« ç¯€ã€æ²»ç™‚å¸«ã€æ™‚é–“ç¯„åœç­‰ï¼‰
        session: è³‡æ–™åº«æœƒè©±
        
    Returns:
        åˆ†é çš„å›é¥‹åˆ—è¡¨å›æ‡‰
        
    Raises:
        HTTPException: ç•¶æŸ¥è©¢å¤±æ•—æ™‚
    """
```

##### 3.1.2 å–å¾—å›é¥‹è©³æƒ…
```python
async def get_feedback_detail(
    feedback_id: uuid.UUID,
    patient_id: uuid.UUID,
    session: Session
) -> PatientFeedbackDetailResponse:
    """
    å–å¾—ç‰¹å®šå›é¥‹çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…å« AI åˆ†æå°æ¯”
    
    Args:
        feedback_id: å›é¥‹ ID
        patient_id: æ‚£è€… IDï¼ˆæ¬Šé™é©—è­‰ï¼‰
        session: è³‡æ–™åº«æœƒè©±
        
    Returns:
        è©³ç´°å›é¥‹è³‡è¨Šå›æ‡‰
        
    Raises:
        HTTPException: ç•¶å›é¥‹ä¸å­˜åœ¨æˆ–ç„¡æ¬Šé™æ™‚
    """
```

##### 3.1.3 å»ºç«‹æ‚£è€…å›æ‡‰
```python
async def create_patient_response(
    feedback_id: uuid.UUID,
    patient_id: uuid.UUID,
    response_data: PatientResponseCreate,
    session: Session
) -> PatientResponseResponse:
    """
    å»ºç«‹æ‚£è€…å°æ²»ç™‚å¸«å›é¥‹çš„å›æ‡‰
    
    Args:
        feedback_id: å›é¥‹ ID
        patient_id: æ‚£è€… ID
        response_data: å›æ‡‰è³‡æ–™
        session: è³‡æ–™åº«æœƒè©±
        
    Returns:
        æ‚£è€…å›æ‡‰å›æ‡‰
        
    Raises:
        HTTPException: ç•¶å›é¥‹ä¸å­˜åœ¨æˆ–ç„¡æ¬Šé™æ™‚
    """
```

##### 3.1.4 å–å¾—å›é¥‹çµ±è¨ˆ
```python
async def get_patient_feedback_statistics(
    patient_id: uuid.UUID,
    session: Session
) -> PatientFeedbackStatisticsResponse:
    """
    å–å¾—æ‚£è€…å›é¥‹çµ±è¨ˆè³‡è¨Š
    
    Args:
        patient_id: æ‚£è€… ID
        session: è³‡æ–™åº«æœƒè©±
        
    Returns:
        çµ±è¨ˆè³‡è¨Šå›æ‡‰
        
    Raises:
        HTTPException: ç•¶æŸ¥è©¢å¤±æ•—æ™‚
    """
```

### 3.2 æ¥­å‹™é‚è¼¯è™•ç†

#### æ¬Šé™é©—è­‰é‚è¼¯
- é©—è­‰æ‚£è€…èº«ä»½
- ç¢ºèªå›é¥‹å±¬æ–¼è©²æ‚£è€…çš„ç·´ç¿’æœƒè©±
- æª¢æŸ¥æ²»ç™‚å¸«èˆ‡æ‚£è€…çš„é…å°é—œä¿‚

#### è³‡æ–™æŸ¥è©¢å’Œéæ¿¾é‚è¼¯
- è¤‡åˆæŸ¥è©¢ï¼šçµåˆ `PracticeSessionFeedback`ã€`AIAnalysisResult`ã€`PracticeRecord`
- åˆ†é è™•ç†ï¼šæ”¯æ´å¤§é‡è³‡æ–™çš„åˆ†é æŸ¥è©¢
- ç¯©é¸æ¢ä»¶ï¼šæ™‚é–“ã€ç« ç¯€ã€æ²»ç™‚å¸«ç­‰å¤šç¶­åº¦ç¯©é¸

#### èˆ‡ç¾æœ‰æœå‹™çš„æ•´åˆ
- æ•´åˆç¾æœ‰çš„ `feedback_service.py`
- é‡ç”¨ AI åˆ†æçµæœæŸ¥è©¢é‚è¼¯
- æ•´åˆéŸ³è¨Šæª”æ¡ˆå­˜å–æœå‹™

## 4. Models è¦åŠƒ

### 4.1 æ–°å¢è³‡æ–™æ¨¡å‹

#### 4.1.1 æ‚£è€…å›æ‡‰è¡¨ (`PatientFeedbackResponse`)

```python
class PatientFeedbackResponse(SQLModel, table=True):
    """æ‚£è€…å°æ²»ç™‚å¸«å›é¥‹çš„å›æ‡‰è¡¨"""
    __tablename__ = "patient_feedback_responses"

    response_id: Optional[uuid.UUID] = Field(default_factory=uuid.uuid4, primary_key=True)
    session_feedback_id: uuid.UUID = Field(foreign_key="practice_session_feedbacks.session_feedback_id")
    patient_id: uuid.UUID = Field(foreign_key="users.user_id")
    
    # å›æ‡‰å…§å®¹
    content: str  # å›æ‡‰å…§å®¹
    response_type: str = Field(default="response", max_length=20)  # "response" æˆ– "question"
    
    # æ™‚é–“æˆ³è¨˜
    created_at: datetime.datetime = Field(default_factory=datetime.datetime.now)
    updated_at: datetime.datetime = Field(default_factory=datetime.datetime.now)

    # Relationships
    session_feedback: PracticeSessionFeedback = Relationship()
    patient: "User" = Relationship()
```

#### 4.1.2 è³‡æ–™åº«é·ç§»

éœ€è¦å»ºç«‹æ–°çš„é·ç§»æª”æ¡ˆä»¥æ–°å¢æ‚£è€…å›æ‡‰è¡¨ï¼š

```bash
cd alembic
uv run alembic revision --autogenerate -m "æ–°å¢æ‚£è€…å›é¥‹å›æ‡‰è¡¨"
uv run alembic upgrade head
```

### 4.2 ç¾æœ‰æ¨¡å‹èª¿æ•´éœ€æ±‚

#### 4.2.1 PracticeSessionFeedback æ¨¡å‹èª¿æ•´

ç¾æœ‰çš„ `PracticeSessionFeedback` æ¨¡å‹å·²ç¶“è¶³å¤ å®Œæ•´ï¼Œä½†å»ºè­°æ–°å¢é—œä¿‚ï¼š

```python
# åœ¨ PracticeSessionFeedback ä¸­æ–°å¢
patient_responses: List["PatientFeedbackResponse"] = Relationship(back_populates="session_feedback")
```

#### 4.2.2 è³‡æ–™é—œè¯è¨­è¨ˆ

```
PracticeSession (1) â†â†’ (1) PracticeSessionFeedback
    â†“                          â†“
    user_id                patient_responses (1â†’å¤š)
    â†“                          â†“
    ç·´ç¿’æœƒè©±å±¬æ–¼æ‚£è€…          PatientFeedbackResponse
    
PracticeSession (1) â†â†’ (å¤š) PracticeRecord (1) â†â†’ (0-1) AIAnalysisTask (1) â†â†’ (0-1) AIAnalysisResult
```

## 5. Schema è¦åŠƒ

### 5.1 æ–°å¢ Schema å®šç¾©

#### 5.1.1 æ‚£è€…å›é¥‹ç›¸é—œ Schemas

```python
# æª”æ¡ˆä½ç½®ï¼šsrc/practice/schemas/patient_feedback.py

class FeedbackFilters(BaseModel):
    """å›é¥‹ç¯©é¸æ¢ä»¶"""
    page: int = Field(default=1, ge=1)
    limit: int = Field(default=10, ge=1, le=50)
    chapter_id: Optional[UUID] = None
    therapist_id: Optional[UUID] = None
    start_date: Optional[datetime] = None
    end_date: Optional[datetime] = None
    has_ai_analysis: Optional[bool] = None

class PatientFeedbackListItem(BaseModel):
    """æ‚£è€…å›é¥‹åˆ—è¡¨é …ç›®"""
    session_feedback_id: UUID
    practice_session_id: UUID
    chapter_name: str
    therapist_name: str
    therapist_specialties: List[str]
    content: str
    has_ai_analysis: bool
    created_at: datetime
    patient_responses_count: int

class PaginatedFeedbackListResponse(BaseModel):
    """åˆ†é å›é¥‹åˆ—è¡¨å›æ‡‰"""
    feedbacks: List[PatientFeedbackListItem]
    pagination: PaginationInfo

class PatientFeedbackDetailResponse(BaseModel):
    """æ‚£è€…å›é¥‹è©³æƒ…å›æ‡‰"""
    session_feedback_id: UUID
    practice_session_id: UUID
    chapter: ChapterInfo
    therapist: TherapistInfo
    therapist_feedback: TherapistFeedbackDetail
    ai_analysis: Optional[AIAnalysisDetail]
    practice_records: List[PracticeRecordDetail]
    patient_responses: List[PatientResponseDetail]

class PatientResponseCreate(BaseModel):
    """æ‚£è€…å›æ‡‰å»ºç«‹è«‹æ±‚"""
    content: str = Field(min_length=1, max_length=1000)
    response_type: str = Field(default="response", regex="^(response|question)$")

class PatientResponseResponse(BaseModel):
    """æ‚£è€…å›æ‡‰å›æ‡‰"""
    response_id: UUID
    feedback_id: UUID
    content: str
    response_type: str
    created_at: datetime

class PatientFeedbackStatisticsResponse(BaseModel):
    """æ‚£è€…å›é¥‹çµ±è¨ˆå›æ‡‰"""
    total_feedbacks: int
    feedbacks_this_month: int
    avg_improvement_score: Optional[float]
    most_active_therapist: Optional[TherapistSummary]
    chapter_feedback_distribution: List[ChapterFeedbackCount]
```

## 6. ä¸‰è€…ä¹‹é—œè¯

### 6.1 æ¶æ§‹äº’å‹•æµç¨‹

```
Patient Request â†’ Router â†’ Service â†’ Database
                     â†“
                 Authentication & 
                 Authorization
                     â†“
              Schema Validation
                     â†“
              Business Logic
                     â†“
                 Data Access
                     â†“
              Response Format
```

### 6.2 è³‡æ–™æµå‘åœ–

```
1. æ‚£è€…è«‹æ±‚å›é¥‹åˆ—è¡¨
   GET /api/practice/patient/feedbacks
   â†“
   patient_feedback_router.get_feedbacks()
   â†“
   patient_feedback_service.get_patient_feedbacks()
   â†“
   SQL æŸ¥è©¢ï¼šPracticeSessionFeedback + AIAnalysisResult + æ²»ç™‚å¸«è³‡è¨Š
   â†“
   æ ¼å¼åŒ–ç‚º PaginatedFeedbackListResponse
   â†“
   è¿”å› JSON å›æ‡‰

2. æ‚£è€…æŸ¥çœ‹å›é¥‹è©³æƒ…
   GET /api/practice/patient/feedbacks/{feedback_id}
   â†“
   patient_feedback_router.get_feedback_detail()
   â†“
   patient_feedback_service.get_feedback_detail()
   â†“
   SQL æŸ¥è©¢ï¼šé—œè¯æŸ¥è©¢æ‰€æœ‰ç›¸é—œè³‡æ–™
   â†“
   æ ¼å¼åŒ–ç‚º PatientFeedbackDetailResponse
   â†“
   è¿”å› JSON å›æ‡‰

3. æ‚£è€…å›æ‡‰å›é¥‹
   POST /api/practice/patient/feedbacks/{feedback_id}/responses
   â†“
   patient_feedback_router.create_response()
   â†“
   patient_feedback_service.create_patient_response()
   â†“
   å»ºç«‹ PatientFeedbackResponse è¨˜éŒ„
   â†“
   è¿”å› PatientResponseResponse
```

### 6.3 éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

#### Router å±¤éŒ¯èª¤è™•ç†
- åƒæ•¸é©—è­‰éŒ¯èª¤ï¼š`400 Bad Request`
- èªè­‰å¤±æ•—ï¼š`401 Unauthorized`
- æ¬Šé™ä¸è¶³ï¼š`403 Forbidden`
- è³‡æºä¸å­˜åœ¨ï¼š`404 Not Found`

#### Service å±¤éŒ¯èª¤è™•ç†
- æ¥­å‹™é‚è¼¯éŒ¯èª¤ï¼šæ‹‹å‡º `HTTPException`
- è³‡æ–™åº«æ“ä½œéŒ¯èª¤ï¼šè¨˜éŒ„æ—¥èªŒä¸¦é‡æ–°æ‹‹å‡º
- æ¬Šé™é©—è­‰å¤±æ•—ï¼šæ‹‹å‡ºç›¸æ‡‰çš„ HTTP éŒ¯èª¤

#### Model å±¤éŒ¯èª¤è™•ç†
- è³‡æ–™å®Œæ•´æ€§éŒ¯èª¤ï¼šæ‹‹å‡º `IntegrityError`
- è³‡æ–™é©—è­‰éŒ¯èª¤ï¼šæ‹‹å‡º `ValidationError`

## 7. å¯¦ä½œå»ºè­°å’Œæ³¨æ„äº‹é …

### 7.1 æ•ˆèƒ½å„ªåŒ–

1. **è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–**
   - ä½¿ç”¨ JOIN æŸ¥è©¢æ¸›å°‘è³‡æ–™åº«å¾€è¿”
   - é©ç•¶å»ºç«‹ç´¢å¼•ï¼ˆä¾‹å¦‚åœ¨ `user_id`, `created_at` ä¸Šï¼‰
   - ä½¿ç”¨è³‡æ–™åº«å±¤åˆ†é é¿å…è¨˜æ†¶é«”å•é¡Œ

2. **å¿«å–ç­–ç•¥**
   - è€ƒæ…®å°æ²»ç™‚å¸«è³‡è¨Šé€²è¡Œå¿«å–
   - çµ±è¨ˆè³‡æ–™å¯ä»¥ä½¿ç”¨çŸ­æœŸå¿«å–

### 7.2 å®‰å…¨è€ƒé‡

1. **è³‡æ–™æ¬Šé™**
   - åš´æ ¼é©—è­‰æ‚£è€…åªèƒ½å­˜å–è‡ªå·±çš„è³‡æ–™
   - é˜²æ­¢é€é URL æ“ä½œå­˜å–å…¶ä»–æ‚£è€…çš„å›é¥‹

2. **è¼¸å…¥é©—è­‰**
   - å°æ‰€æœ‰ä½¿ç”¨è€…è¼¸å…¥é€²è¡Œåš´æ ¼é©—è­‰
   - é˜²ç¯„ SQL æ³¨å…¥å’Œ XSS æ”»æ“Š

### 7.3 æ“´å±•æ€§è¨­è¨ˆ

1. **é€šçŸ¥ç³»çµ±é ç•™**
   - ç‚ºæœªä¾†çš„é€šçŸ¥åŠŸèƒ½é ç•™è³‡æ–™çµæ§‹
   - è¨­è¨ˆäº‹ä»¶é©…å‹•çš„æ¶æ§‹ä¾¿æ–¼å¾ŒçºŒæ•´åˆ

2. **API ç‰ˆæœ¬æ§åˆ¶**
   - è€ƒæ…® API ç‰ˆæœ¬æ§åˆ¶ä»¥æ”¯æ´æœªä¾†çš„åŠŸèƒ½æ“´å±•
   - ä¿æŒå‘å¾Œç›¸å®¹æ€§

### 7.4 æ¸¬è©¦ç­–ç•¥

1. **å–®å…ƒæ¸¬è©¦**
   - Service å±¤çš„æ¥­å‹™é‚è¼¯æ¸¬è©¦
   - æ¬Šé™é©—è­‰æ¸¬è©¦
   - è³‡æ–™æŸ¥è©¢é‚è¼¯æ¸¬è©¦

2. **æ•´åˆæ¸¬è©¦**
   - API ç«¯é»çš„å®Œæ•´æ¸¬è©¦
   - è³‡æ–™åº«æ“ä½œæ¸¬è©¦

3. **æ¸¬è©¦è³‡æ–™**
   - å»ºç«‹å®Œæ•´çš„æ¸¬è©¦è³‡æ–™é›†
   - æ¨¡æ“¬å„ç¨®é‚Šç•Œæƒ…æ³

## 8. é–‹ç™¼é †åºå»ºè­°

### ç¬¬ä¸€éšæ®µï¼šåŸºç¤åŠŸèƒ½
1. å»ºç«‹æ‚£è€…å›æ‡‰è³‡æ–™æ¨¡å‹å’Œé·ç§»
2. å¯¦ä½œæ‚£è€…å›é¥‹æŸ¥çœ‹æœå‹™
3. å»ºç«‹åŸºæœ¬çš„ API ç«¯é»

### ç¬¬äºŒéšæ®µï¼šé€²éšåŠŸèƒ½
1. å¯¦ä½œç¯©é¸å’Œåˆ†é åŠŸèƒ½
2. æ–°å¢ AI åˆ†æå°æ¯”æª¢è¦–
3. å¯¦ä½œæ‚£è€…å›æ‡‰åŠŸèƒ½

### ç¬¬ä¸‰éšæ®µï¼šå„ªåŒ–å’Œæ•´åˆ
1. æ•ˆèƒ½å„ªåŒ–å’Œå¿«å–
2. çµ±è¨ˆè³‡è¨ŠåŠŸèƒ½
3. å®Œå–„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ

### ç¬¬å››éšæ®µï¼šæ¸¬è©¦å’Œæ–‡ä»¶
1. å®Œæ•´çš„æ¸¬è©¦è¦†è“‹
2. API æ–‡ä»¶æ›´æ–°
3. éƒ¨ç½²å’Œç›£æ§è¨­ç½®

é€™å€‹è¦åŠƒæä¾›äº†å®Œæ•´çš„æŠ€è¡“æ¶æ§‹è¨­è¨ˆï¼Œå¯ä»¥ä½œç‚ºé–‹ç™¼åœ˜éšŠå¯¦ä½œæ‚£è€…ç«¯å–å¾—æ²»ç™‚å¸«å›é¥‹åŠŸèƒ½çš„å…·é«”æŒ‡å—ã€‚æ‰€æœ‰çš„è¨­è¨ˆéƒ½åŸºæ–¼ç¾æœ‰çš„è³‡æ–™æ¨¡å‹å’Œæ¶æ§‹æ¨¡å¼ï¼Œç¢ºä¿èˆ‡ç¾æœ‰ç³»çµ±çš„ä¸€è‡´æ€§å’Œç›¸å®¹æ€§ã€‚