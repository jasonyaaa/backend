# 患者端取得治療師回饋功能規劃

## 概述

本文件規劃患者端查看和互動治療師回饋功能的完整架構設計。基於現有的 `PracticeSessionFeedback` 和 `AIAnalysisResult` 模型，設計患者可以查看所有已完成練習會話的回饋，並提供篩選、查看詳情和互動功能。

## 1. 功能規劃

### 1.1 核心功能需求

#### 查看權限與範圍
- ✅ 患者可以查看所有已完成練習會話的回饋
- ✅ 支援篩選功能（按時間範圍、章節、治療師篩選）
- ✅ 患者可以同時查看 AI 分析結果和治療師回饋
- ✅ 回饋需要包含治療師的基本資訊（姓名、專長等）

#### 回饋內容展示
- 展示治療師回饋的完整內容
- 展示對應的 AI 分析結果（如存在）
- 關聯展示練習記錄（音訊檔案）
- 提供 AI 分析與治療師回饋的對比檢視

#### 互動功能
- ✅ 患者能對回饋進行回應或提問
- 建立患者與治療師的簡易溝通機制

#### 通知機制
- 🚧 #TODO: 當有新回饋時通知患者（預留功能）

### 1.2 用戶使用流程

```
患者登入 → 進入回饋頁面 → 
篩選回饋列表 → 選擇特定回饋 → 
查看詳細內容（治療師回饋 + AI 分析對比）→ 
查看關聯練習記錄 → 
（可選）回應或提問 → 完成
```

### 1.3 業務規則

1. **權限控制**：患者只能查看自己的練習會話回饋
2. **資料完整性**：只有已完成的練習會話才可能有治療師回饋
3. **回饋可見性**：所有治療師回饋對患者可見，無隱私限制
4. **互動限制**：患者只能回應，不能修改或刪除回饋
5. **關聯展示**：回饋必須與對應的練習記錄和 AI 分析結果關聯展示

## 2. Router 規劃

### 2.1 患者回饋查看路由器 (`patient_feedback_router.py`)

```python
# 路由器檔案位置：src/practice/routers/patient_feedback_router.py
# 路由器名稱：patient_feedback_router
```

#### API 端點設計

##### 2.1.1 取得回饋列表
```
GET /api/practice/patient/feedbacks
```

**功能**：取得患者的所有回饋列表，支援篩選和分頁

**Query Parameters**：
- `page`: 頁碼 (預設: 1)
- `limit`: 每頁數量 (預設: 10, 最大: 50)
- `chapter_id`: 章節 ID 篩選 (可選)
- `therapist_id`: 治療師 ID 篩選 (可選)
- `start_date`: 開始日期篩選 (可選，ISO 格式)
- `end_date`: 結束日期篩選 (可選，ISO 格式)
- `has_ai_analysis`: 是否包含 AI 分析 (可選，boolean)

**回應格式**：
```json
{
  "feedbacks": [
    {
      "session_feedback_id": "uuid",
      "practice_session_id": "uuid",
      "chapter_name": "基本對話",
      "therapist_name": "張治療師",
      "therapist_specialties": ["發音矯正", "語調訓練"],
      "content": "整體表現良好...",
      "has_ai_analysis": true,
      "created_at": "2025-07-30T14:30:00.000Z",
      "patient_responses_count": 2
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total_items": 25,
    "total_pages": 3
  }
}
```

##### 2.1.2 取得回饋詳情
```
GET /api/practice/patient/feedbacks/{feedback_id}
```

**功能**：取得特定回饋的詳細資訊，包含 AI 分析對比

**Path Parameters**：
- `feedback_id`: 回饋 ID

**回應格式**：
```json
{
  "session_feedback_id": "uuid",
  "practice_session_id": "uuid",
  "chapter": {
    "chapter_id": "uuid",
    "chapter_name": "基本對話",
    "description": "日常對話練習"
  },
  "therapist": {
    "therapist_id": "uuid",
    "name": "張治療師",
    "specialties": ["發音矯正", "語調訓練"],
    "years_experience": 5
  },
  "therapist_feedback": {
    "content": "整體表現良好...",
    "created_at": "2025-07-30T14:30:00.000Z"
  },
  "ai_analysis": {
    "analysis_result": {
      "overall_score": 85,
      "pronunciation_accuracy": 88,
      "fluency_score": 82,
      "detailed_analysis": "..."
    },
    "created_at": "2025-07-30T14:00:00.000Z"
  },
  "practice_records": [
    {
      "practice_record_id": "uuid",
      "sentence_content": "你好，很高興見到你",
      "audio_path": "/audio/path",
      "audio_duration": 3.5,
      "recorded_at": "2025-07-30T13:45:00.000Z"
    }
  ],
  "patient_responses": [
    {
      "response_id": "uuid",
      "content": "謝謝治療師的指導",
      "created_at": "2025-07-30T15:00:00.000Z"
    }
  ]
}
```

##### 2.1.3 回應回饋
```
POST /api/practice/patient/feedbacks/{feedback_id}/responses
```

**功能**：患者對治療師回饋進行回應或提問

**Path Parameters**：
- `feedback_id`: 回饋 ID

**請求格式**：
```json
{
  "content": "謝謝治療師的詳細回饋，我會加強語調練習",
  "response_type": "response"  // "response" 或 "question"
}
```

**回應格式**：
```json
{
  "response_id": "uuid",
  "feedback_id": "uuid",
  "content": "謝謝治療師的詳細回饋，我會加強語調練習",
  "response_type": "response",
  "created_at": "2025-07-30T15:00:00.000Z"
}
```

##### 2.1.4 取得回饋統計
```
GET /api/practice/patient/feedbacks/statistics
```

**功能**：取得患者回饋的統計資訊

**回應格式**：
```json
{
  "total_feedbacks": 25,
  "feedbacks_this_month": 8,
  "avg_improvement_score": 78.5,
  "most_active_therapist": {
    "therapist_id": "uuid",
    "name": "張治療師",
    "feedback_count": 15
  },
  "chapter_feedback_distribution": [
    {
      "chapter_name": "基本對話",
      "feedback_count": 10
    }
  ]
}
```

### 2.2 權限控制機制

#### 身份驗證
- 使用現有的 JWT token 驗證
- 確保只有患者身份可以存取

#### 資料權限
- 只能查看自己的練習會話回饋
- 透過 `user_id` 與 `practice_session.user_id` 比對確認權限

#### 錯誤處理
- `403 Forbidden`：無權限存取
- `404 Not Found`：回饋不存在
- `400 Bad Request`：請求參數錯誤

## 3. Service 規劃

### 3.1 患者回饋服務 (`patient_feedback_service.py`)

```python
# 服務檔案位置：src/practice/services/patient_feedback_service.py
```

#### 核心服務函數

##### 3.1.1 取得患者回饋列表
```python
async def get_patient_feedbacks(
    patient_id: uuid.UUID,
    filters: FeedbackFilters,
    session: Session
) -> PaginatedFeedbackListResponse:
    """
    取得患者的回饋列表，支援篩選和分頁
    
    Args:
        patient_id: 患者 ID
        filters: 篩選條件（章節、治療師、時間範圍等）
        session: 資料庫會話
        
    Returns:
        分頁的回饋列表回應
        
    Raises:
        HTTPException: 當查詢失敗時
    """
```

##### 3.1.2 取得回饋詳情
```python
async def get_feedback_detail(
    feedback_id: uuid.UUID,
    patient_id: uuid.UUID,
    session: Session
) -> PatientFeedbackDetailResponse:
    """
    取得特定回饋的詳細資訊，包含 AI 分析對比
    
    Args:
        feedback_id: 回饋 ID
        patient_id: 患者 ID（權限驗證）
        session: 資料庫會話
        
    Returns:
        詳細回饋資訊回應
        
    Raises:
        HTTPException: 當回饋不存在或無權限時
    """
```

##### 3.1.3 建立患者回應
```python
async def create_patient_response(
    feedback_id: uuid.UUID,
    patient_id: uuid.UUID,
    response_data: PatientResponseCreate,
    session: Session
) -> PatientResponseResponse:
    """
    建立患者對治療師回饋的回應
    
    Args:
        feedback_id: 回饋 ID
        patient_id: 患者 ID
        response_data: 回應資料
        session: 資料庫會話
        
    Returns:
        患者回應回應
        
    Raises:
        HTTPException: 當回饋不存在或無權限時
    """
```

##### 3.1.4 取得回饋統計
```python
async def get_patient_feedback_statistics(
    patient_id: uuid.UUID,
    session: Session
) -> PatientFeedbackStatisticsResponse:
    """
    取得患者回饋統計資訊
    
    Args:
        patient_id: 患者 ID
        session: 資料庫會話
        
    Returns:
        統計資訊回應
        
    Raises:
        HTTPException: 當查詢失敗時
    """
```

### 3.2 業務邏輯處理

#### 權限驗證邏輯
- 驗證患者身份
- 確認回饋屬於該患者的練習會話
- 檢查治療師與患者的配對關係

#### 資料查詢和過濾邏輯
- 複合查詢：結合 `PracticeSessionFeedback`、`AIAnalysisResult`、`PracticeRecord`
- 分頁處理：支援大量資料的分頁查詢
- 篩選條件：時間、章節、治療師等多維度篩選

#### 與現有服務的整合
- 整合現有的 `feedback_service.py`
- 重用 AI 分析結果查詢邏輯
- 整合音訊檔案存取服務

## 4. Models 規劃

### 4.1 新增資料模型

#### 4.1.1 患者回應表 (`PatientFeedbackResponse`)

```python
class PatientFeedbackResponse(SQLModel, table=True):
    """患者對治療師回饋的回應表"""
    __tablename__ = "patient_feedback_responses"

    response_id: Optional[uuid.UUID] = Field(default_factory=uuid.uuid4, primary_key=True)
    session_feedback_id: uuid.UUID = Field(foreign_key="practice_session_feedbacks.session_feedback_id")
    patient_id: uuid.UUID = Field(foreign_key="users.user_id")
    
    # 回應內容
    content: str  # 回應內容
    response_type: str = Field(default="response", max_length=20)  # "response" 或 "question"
    
    # 時間戳記
    created_at: datetime.datetime = Field(default_factory=datetime.datetime.now)
    updated_at: datetime.datetime = Field(default_factory=datetime.datetime.now)

    # Relationships
    session_feedback: PracticeSessionFeedback = Relationship()
    patient: "User" = Relationship()
```

#### 4.1.2 資料庫遷移

需要建立新的遷移檔案以新增患者回應表：

```bash
cd alembic
uv run alembic revision --autogenerate -m "新增患者回饋回應表"
uv run alembic upgrade head
```

### 4.2 現有模型調整需求

#### 4.2.1 PracticeSessionFeedback 模型調整

現有的 `PracticeSessionFeedback` 模型已經足夠完整，但建議新增關係：

```python
# 在 PracticeSessionFeedback 中新增
patient_responses: List["PatientFeedbackResponse"] = Relationship(back_populates="session_feedback")
```

#### 4.2.2 資料關聯設計

```
PracticeSession (1) ←→ (1) PracticeSessionFeedback
    ↓                          ↓
    user_id                patient_responses (1→多)
    ↓                          ↓
    練習會話屬於患者          PatientFeedbackResponse
    
PracticeSession (1) ←→ (多) PracticeRecord (1) ←→ (0-1) AIAnalysisTask (1) ←→ (0-1) AIAnalysisResult
```

## 5. Schema 規劃

### 5.1 新增 Schema 定義

#### 5.1.1 患者回饋相關 Schemas

```python
# 檔案位置：src/practice/schemas/patient_feedback.py

class FeedbackFilters(BaseModel):
    """回饋篩選條件"""
    page: int = Field(default=1, ge=1)
    limit: int = Field(default=10, ge=1, le=50)
    chapter_id: Optional[UUID] = None
    therapist_id: Optional[UUID] = None
    start_date: Optional[datetime] = None
    end_date: Optional[datetime] = None
    has_ai_analysis: Optional[bool] = None

class PatientFeedbackListItem(BaseModel):
    """患者回饋列表項目"""
    session_feedback_id: UUID
    practice_session_id: UUID
    chapter_name: str
    therapist_name: str
    therapist_specialties: List[str]
    content: str
    has_ai_analysis: bool
    created_at: datetime
    patient_responses_count: int

class PaginatedFeedbackListResponse(BaseModel):
    """分頁回饋列表回應"""
    feedbacks: List[PatientFeedbackListItem]
    pagination: PaginationInfo

class PatientFeedbackDetailResponse(BaseModel):
    """患者回饋詳情回應"""
    session_feedback_id: UUID
    practice_session_id: UUID
    chapter: ChapterInfo
    therapist: TherapistInfo
    therapist_feedback: TherapistFeedbackDetail
    ai_analysis: Optional[AIAnalysisDetail]
    practice_records: List[PracticeRecordDetail]
    patient_responses: List[PatientResponseDetail]

class PatientResponseCreate(BaseModel):
    """患者回應建立請求"""
    content: str = Field(min_length=1, max_length=1000)
    response_type: str = Field(default="response", regex="^(response|question)$")

class PatientResponseResponse(BaseModel):
    """患者回應回應"""
    response_id: UUID
    feedback_id: UUID
    content: str
    response_type: str
    created_at: datetime

class PatientFeedbackStatisticsResponse(BaseModel):
    """患者回饋統計回應"""
    total_feedbacks: int
    feedbacks_this_month: int
    avg_improvement_score: Optional[float]
    most_active_therapist: Optional[TherapistSummary]
    chapter_feedback_distribution: List[ChapterFeedbackCount]
```

## 6. 三者之關聯

### 6.1 架構互動流程

```
Patient Request → Router → Service → Database
                     ↓
                 Authentication & 
                 Authorization
                     ↓
              Schema Validation
                     ↓
              Business Logic
                     ↓
                 Data Access
                     ↓
              Response Format
```

### 6.2 資料流向圖

```
1. 患者請求回饋列表
   GET /api/practice/patient/feedbacks
   ↓
   patient_feedback_router.get_feedbacks()
   ↓
   patient_feedback_service.get_patient_feedbacks()
   ↓
   SQL 查詢：PracticeSessionFeedback + AIAnalysisResult + 治療師資訊
   ↓
   格式化為 PaginatedFeedbackListResponse
   ↓
   返回 JSON 回應

2. 患者查看回饋詳情
   GET /api/practice/patient/feedbacks/{feedback_id}
   ↓
   patient_feedback_router.get_feedback_detail()
   ↓
   patient_feedback_service.get_feedback_detail()
   ↓
   SQL 查詢：關聯查詢所有相關資料
   ↓
   格式化為 PatientFeedbackDetailResponse
   ↓
   返回 JSON 回應

3. 患者回應回饋
   POST /api/practice/patient/feedbacks/{feedback_id}/responses
   ↓
   patient_feedback_router.create_response()
   ↓
   patient_feedback_service.create_patient_response()
   ↓
   建立 PatientFeedbackResponse 記錄
   ↓
   返回 PatientResponseResponse
```

### 6.3 錯誤處理機制

#### Router 層錯誤處理
- 參數驗證錯誤：`400 Bad Request`
- 認證失敗：`401 Unauthorized`
- 權限不足：`403 Forbidden`
- 資源不存在：`404 Not Found`

#### Service 層錯誤處理
- 業務邏輯錯誤：拋出 `HTTPException`
- 資料庫操作錯誤：記錄日誌並重新拋出
- 權限驗證失敗：拋出相應的 HTTP 錯誤

#### Model 層錯誤處理
- 資料完整性錯誤：拋出 `IntegrityError`
- 資料驗證錯誤：拋出 `ValidationError`

## 7. 實作建議和注意事項

### 7.1 效能優化

1. **資料庫查詢優化**
   - 使用 JOIN 查詢減少資料庫往返
   - 適當建立索引（例如在 `user_id`, `created_at` 上）
   - 使用資料庫層分頁避免記憶體問題

2. **快取策略**
   - 考慮對治療師資訊進行快取
   - 統計資料可以使用短期快取

### 7.2 安全考量

1. **資料權限**
   - 嚴格驗證患者只能存取自己的資料
   - 防止透過 URL 操作存取其他患者的回饋

2. **輸入驗證**
   - 對所有使用者輸入進行嚴格驗證
   - 防範 SQL 注入和 XSS 攻擊

### 7.3 擴展性設計

1. **通知系統預留**
   - 為未來的通知功能預留資料結構
   - 設計事件驅動的架構便於後續整合

2. **API 版本控制**
   - 考慮 API 版本控制以支援未來的功能擴展
   - 保持向後相容性

### 7.4 測試策略

1. **單元測試**
   - Service 層的業務邏輯測試
   - 權限驗證測試
   - 資料查詢邏輯測試

2. **整合測試**
   - API 端點的完整測試
   - 資料庫操作測試

3. **測試資料**
   - 建立完整的測試資料集
   - 模擬各種邊界情況

## 8. 開發順序建議

### 第一階段：基礎功能
1. 建立患者回應資料模型和遷移
2. 實作患者回饋查看服務
3. 建立基本的 API 端點

### 第二階段：進階功能
1. 實作篩選和分頁功能
2. 新增 AI 分析對比檢視
3. 實作患者回應功能

### 第三階段：優化和整合
1. 效能優化和快取
2. 統計資訊功能
3. 完善錯誤處理和日誌

### 第四階段：測試和文件
1. 完整的測試覆蓋
2. API 文件更新
3. 部署和監控設置

這個規劃提供了完整的技術架構設計，可以作為開發團隊實作患者端取得治療師回饋功能的具體指南。所有的設計都基於現有的資料模型和架構模式，確保與現有系統的一致性和相容性。